<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de Artículos</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Animación fade-slide para alternar tablas */
    .fade {
      opacity: 0;
      transform: translateY(40px) scale(0.98);
      transition: opacity 0.5s, transform 0.5s;
      pointer-events: none;
    }
    .fade-in {
      opacity: 1 !important;
      transform: translateY(0) scale(1);
      transition: opacity 0.5s, transform 0.5s;
      pointer-events: auto;
    }
    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1a73e8;
      color: #1a4c8b;
      text-align: center;
    }

    .modal-content label {
      display: block;
      margin-top: 12px;
      font-weight: 500;
      color: #333;
    }

    .modal-content input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 4px;
    }

    .modal-footer {
      text-align: right;
      margin-top: 20px;
    }

    .modal-footer button {
      margin-left: 10px;
    }

  </style>
  <style>
    /* Estilo especial para la tabla de clientes */
    #tablaClientes {
      background: #e8f5e9;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(56, 142, 60, 0.10);
    }
    #tablaClientes th {
      background: #388e3c;
      color: #fff;
    }
    #tablaClientes td {
      background: #e8f5e9;
    }
  </style>
  <style>
    .datos-generales-card {
      background: #fff;
      color: #222;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      padding: 18px 28px 18px 28px;
      margin-bottom: 24px;
      margin-top: -10px;
      max-width: 420px;
      font-size: 1.08rem;
      font-family: 'Segoe UI', sans-serif;
      display: none;
    }
    .datos-generales-card strong {
      color: #1a73e8;
      font-weight: 600;
      margin-right: 8px;
    }
    .datos-generales-card .dato-row {
      margin-bottom: 6px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
  </style>
</head>

<div style="width:100%;text-align:right;font-size:11px;color:#fff;background:transparent;position:relative;top:0;z-index:3000;letter-spacing:1px;user-select:none;pointer-events:none;">versión 1.1</div>
<body>

<div class="header-bar">
  <div class="header-logo-title">
    <img src="logo.png" alt="Logo" class="header-logo">
    <h1 class="header-title">Gestor de Artículos</h1>
  </div>
  <div class="header-actions">
    <button id="btnAgregar" style="background-color:#388e3c;">Añadir Artículo</button>
    <button id="btnAlternar" style="background-color:#e67e22;">Alternar</button>
    <button id="btnDatos" style="background-color:#345679;">Datos</button>
    <button id="btnGear" class="gear-btn" title="Opciones"><span>⚙️</span></button>
  </div>
</div>

<!-- Tarjeta de datos generales OCULTA -->
<div id="datosGeneralesCard" class="datos-generales-card" style="display:none;"></div>
<script>

  // Alternar visibilidad de todo menos el header y mostrar la segunda tabla
  window.addEventListener('DOMContentLoaded', function() {
    const btnAlternar = document.getElementById('btnAlternar');
    const headerBar = document.querySelector('.header-bar');
    const tablaClientes = document.getElementById('tablaClientes');
    const tabla = document.getElementById('tabla');
    let alternarOculto = false;

    // Inicializar animación
    tabla.classList.add('fade-in');
    tablaClientes.classList.add('fade');

    btnAlternar.addEventListener('click', function() {
      alternarOculto = !alternarOculto;

      if (alternarOculto) {
        // Fade out tabla principal, fade in clientes con slide
        tabla.classList.remove('fade-in');
        tabla.classList.add('fade');
        setTimeout(() => {
          tabla.style.display = 'none';
          tablaClientes.style.display = 'table';
          // Forzar reflow para que la animación se aplique correctamente
          void tablaClientes.offsetWidth;
          tablaClientes.classList.remove('fade');
          tablaClientes.classList.add('fade-in');
        }, 400);
      } else {
        // Fade out clientes, fade in tabla principal con slide
        tablaClientes.classList.remove('fade-in');
        tablaClientes.classList.add('fade');
        setTimeout(() => {
          tablaClientes.style.display = 'none';
          tabla.style.display = 'table';
          void tabla.offsetWidth;
          tabla.classList.remove('fade');
          tabla.classList.add('fade-in');
        }, 400);
      }
      headerBar.style.display = '';
    });
  });
</script>
<script src="main.js"></script>
<!-- Modal para datos generales -->
<div id="modalDatos" class="modal" style="z-index:2002;">
  <div class="modal-content">
    <h3>Datos Generales</h3>
    <form id="formDatos">
      <label>Empleado
        <input type="text" id="inputEmpleado" name="empleado" required>
      </label>
      <label>BIN (TASA)
        <input type="text" id="inputBIN" name="bin" required>
      </label>
      <label>BCV (TASA)
        <input type="text" id="inputBCV" name="bcv" required>
      </label>
      <div class="modal-footer">
        <button type="button" id="cerrarDatos" style="background-color: #999;">Cancelar</button>
        <button type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

  </div>
</div>
<!-- Modal para carga/descarga de archivo -->
<div id="modalArchivos" class="modal-archivos">
  <div class="modal-archivos-content">
    <h3>Opciones de archivo</h3>
    <label for="cargarArchivo">Cargar archivo</label>
    <input type="file" id="cargarArchivo" accept="application/json">
    <button id="btnDescargar" style="background-color:#388e3c;">Descargar archivo</button>
    <button class="cerrar-archivos">Cerrar</button>
  </div>
</div>

<table id="tabla">
  <thead>
    <tr id="encabezado">
      <th>MODELOS</th>
      <th>BCV (bs)</th>
      <th>DÓLAR BCV</th>
      <th>INICIAL</th>
      <th>CUOTAS</th>
      <th>BALANCE</th>
      <th>BIN</th>
      <th>WEPPA</th>
      <th>OPCIONES</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Segunda tabla (clientes) -->
<table id="tablaClientes" style="display:none;">
  <thead>
    <tr>
      <th>CLIENTE</th>
      <th>MODELO</th>
      <th>COMPRA</th>
      <th>INICIAL</th>
      <th>BALANCE</th>
      <th>PAGO</th>
      <th>CUOTA</th>
      <th>WEPPA</th>
      <th>BIN</th>
      <th>BCV</th>
      <th>OPCIONES</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>




<!-- Modal para registrar cliente -->
<div id="modalCliente" class="modal">
  <div class="modal-content">
    <h3>Registrar Cliente</h3>
    <form id="formCliente" class="form-mitad">
      <div class="fila-inputs">
        <label>Cliente
          <input type="text" id="inputCliente" name="cliente" required class="input-mitad">
        </label>
        <label>Modelo
          <input type="text" id="inputModeloCliente" name="modelo" readonly class="input-mitad">
        </label>
      </div>
      <div class="fila-inputs">
        <label>Inicial
          <input type="text" id="inputInicialCliente" name="inicial" required class="input-mitad">
        </label>
        <label>WEPPA
          <input type="text" id="inputWeppaCliente" name="weppa" readonly class="input-mitad">
        </label>
      </div>
      <div class="fila-inputs">
        <label>Cuotas
          <input type="text" id="inputCuotasCliente" name="cuotas" readonly disabled class="input-mitad">
        </label>
        <label>Fecha
          <input type="text" id="inputFechaCliente" name="fecha" readonly disabled class="input-mitad">
        </label>
      </div>
      <div class="fila-inputs">
        <label>Pago
          <input type="text" id="inputPagoCliente" name="pago" readonly disabled class="input-mitad">
        </label>
      </div>
      <div class="modal-footer">
        <button type="button" id="cerrarModalCliente" style="background-color: #999;">Cancelar</button>
        <button type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>
<style>
  .form-mitad .fila-inputs {
    display: flex;
    gap: 16px;
    margin-bottom: 0px;
  }
  .form-mitad label {
    flex: 1 1 0;
    min-width: 0;
    margin-top: 12px;
  }
  .input-mitad {
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
    font-size: 1rem;
  }

  /* Animación para el modal de agregar artículo */
  #modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0; top: 0; right: 0; bottom: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.25);
    align-items: center;
    justify-content: center;
    transition: background 0.3s;
  }
  #modal.mostrar {
    display: flex;
  }
  #modal .modal-content {
    opacity: 0;
    transform: scale(0.92);
    transition: opacity 0.35s cubic-bezier(.4,0,.2,1), transform 0.35s cubic-bezier(.4,0,.2,1);
  }
  #modal.mostrar .modal-content {
    opacity: 1;
    transform: scale(1);
  }
</style>
<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <h3>Nuevo Artículo</h3>
    <form id="formulario">
      <div id="campos"></div>
      <div class="modal-footer">
        <button type="button" onclick="cerrarFormulario()" style="background-color: #999;">Cancelar</button>
        <button type="submit">Agregar</button>
      </div>
    </form>
  </div>
</div>

<script>



  const btnDatos = document.getElementById("btnDatos");
  const modalDatos = document.getElementById("modalDatos");
  const formDatos = document.getElementById("formDatos");
  const cerrarDatos = document.getElementById("cerrarDatos");
  const inputEmpleado = document.getElementById("inputEmpleado");
  const inputBIN = document.getElementById("inputBIN");
  const inputBCV = document.getElementById("inputBCV");

  btnDatos.onclick = function() {
    // Cargar valores actuales
    inputEmpleado.value = localStorage.getItem('dg_empleado') || '';
    inputBIN.value = localStorage.getItem('dg_bin') || '';
    inputBCV.value = localStorage.getItem('dg_bcv') || '';
    modalDatos.style.display = "flex";
  };
  cerrarDatos.onclick = function() {
    modalDatos.style.display = "none";
    formDatos.reset();
  };
formDatos.onsubmit = function(e) {
    e.preventDefault();
    localStorage.setItem('dg_empleado', inputEmpleado.value);
    localStorage.setItem('dg_bin', inputBIN.value);
    localStorage.setItem('dg_bcv', inputBCV.value);
    modalDatos.style.display = "none";
    formDatos.reset();
    mostrarDatosGeneralesCard();
    actualizarFilasArticulosPorTasas();
  };

// Función para recalcular y actualizar todas las filas de la tabla de artículos
function actualizarFilasArticulosPorTasas() {
  const binTasa = parseFloat(localStorage.getItem('dg_bin')) || 0;
  const bcvTasa = parseFloat(localStorage.getItem('dg_bcv')) || 0;
  const filas = Array.from(tablaBody.querySelectorAll('tr'));
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length < 8) return;
    // Obtener valores necesarios
    const modelo = celdas[0].textContent.trim();
    const paralelos = celdas[6].textContent.replace('$','').trim();
    const weppa = celdas[7].textContent.replace('$','').trim();
    let binInput = parseFloat(paralelos) || 1;
    // Calcular BCV (bs) y DÓLAR BCV
    const bcv = (binTasa * binInput).toFixed(2);
    let dolarBcv = "0";
    if (bcvTasa) {
      dolarBcv = Math.ceil(bcv / bcvTasa).toString();
    }
    // Calcular balance: weppa * -0.4 + weppa
    let weppaNum = parseFloat(weppa) || 0;
    let balance = (weppaNum * -0.4 + weppaNum).toFixed(2);
    // Calcular inicial: redondeado a más (dolarBcv * 1.05) - balance
    let dolarBcvNum = parseFloat(dolarBcv) || 0;
    let balanceNum = parseFloat(balance) || 0;
    let inicial = Math.ceil((dolarBcvNum * 1.05) - balanceNum).toString();
    // Calcular cuotas: redondear a más balance * 1.35 / 6
    let cuotas = Math.ceil((balanceNum * 1.35) / 6).toString();
    // Actualizar celdas
    celdas[1].textContent = bcv + "bs";
    celdas[2].textContent = dolarBcv + "$";
    celdas[3].textContent = inicial + "$";
    celdas[4].textContent = cuotas + "$";
    celdas[5].textContent = balance + "$";
  });
  guardarTabla();
}
  window.addEventListener('click', function(event) {
    if (event.target === modalDatos) {
      modalDatos.style.display = "none";
      formDatos.reset();
    }
  });

  // Modal de archivos
  const btnGear = document.getElementById("btnGear");
  const modalArchivos = document.getElementById("modalArchivos");
  const cerrarArchivosBtn = document.querySelector(".cerrar-archivos");

  btnGear.onclick = function() {
    modalArchivos.style.display = "flex";
  };
  cerrarArchivosBtn.onclick = function() {
    modalArchivos.style.display = "none";
    document.getElementById("cargarArchivo").value = "";
  };
  window.addEventListener('click', function(event) {
    if (event.target === modalArchivos) {
      modalArchivos.style.display = "none";
      document.getElementById("cargarArchivo").value = "";
    }
  });
  // Botón descargar archivo (exporta ambas tablas)
  const btnDescargar = document.getElementById("btnDescargar");
  btnDescargar.onclick = function() {
    const articulos = obtenerDatosTabla();
    const clientes = obtenerDatosTablaClientes();
    const data = {
      articulos: articulos,
      clientes: clientes
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "save.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  // Input cargar archivo (importa ambas tablas si existen)
  const inputCargar = document.getElementById("cargarArchivo");
  inputCargar.onchange = function(e) {
    const archivo = e.target.files[0];
    if (!archivo) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const data = JSON.parse(ev.target.result);
        // Si es el formato nuevo (ambas tablas)
        if (data && typeof data === 'object' && (data.articulos || data.clientes)) {
          // Restaurar artículos
          if (Array.isArray(data.articulos)) {
            tablaBody.innerHTML = "";
            data.articulos.forEach(valores => agregarFila(valores));
            guardarTabla();
          }
          // Restaurar clientes
          if (Array.isArray(data.clientes)) {
            const tablaClientesBody = document.querySelector('#tablaClientes tbody');
            tablaClientesBody.innerHTML = "";
            data.clientes.forEach(valores => agregarFilaCliente(valores));
            guardarTablaClientes();
          }
        } else if (Array.isArray(data)) {
          // Formato antiguo: solo artículos
          tablaBody.innerHTML = "";
          data.forEach(valores => agregarFila(valores));
          guardarTabla();
        } else {
          throw new Error('Formato no reconocido');
        }
      } catch (err) {
        alert("Archivo JSON inválido o formato no soportado");
      }
    };
    reader.readAsText(archivo);
  };
  const body = document.body;
  const modal = document.getElementById("modal");
  const camposContainer = document.getElementById("campos");
  const formulario = document.getElementById("formulario");
  const encabezados = Array.from(document.querySelectorAll("#encabezado th"));
  const tablaBody = document.querySelector("#tabla tbody");
  const btnAgregar = document.getElementById("btnAgregar");

  // Guardar tabla en localStorage y permitir descarga como JSON

  function obtenerDatosTabla() {
    return Array.from(tablaBody.querySelectorAll("tr")).map(tr =>
      Array.from(tr.querySelectorAll("td")).filter(td => !td.classList.contains('eliminar-td')).map(td => td.textContent)
    );
  }

  function guardarTabla() {
    const filas = obtenerDatosTabla();
    localStorage.setItem("tablaArticulos", JSON.stringify(filas));
  }

  // Cargar tabla desde localStorage
  function cargarTabla() {
    const datos = localStorage.getItem("tablaArticulos");
    if (datos) {
      const filas = JSON.parse(datos);
      filas.forEach(valores => {
        agregarFila(valores);
      });
    }
  }


  function agregarFila(valores) {
    const fila = document.createElement("tr");
    valores.forEach((valor, idx) => {
      const celda = document.createElement("td");
      if (idx === 0) {
        // MODELOS en negritas
        celda.innerHTML = `<strong>${valor}</strong>`;
      } else {
        celda.textContent = valor;
      }
      fila.appendChild(celda);
    });
    // Botones de iconos: seleccionar y eliminar
    const celdaOpciones = document.createElement("td");
    celdaOpciones.className = 'eliminar-td';
    celdaOpciones.style.display = 'flex';
    celdaOpciones.style.justifyContent = 'center';
    celdaOpciones.style.alignItems = 'center';
    celdaOpciones.style.gap = '8px';

    // Botón Seleccionar (icono check)
    const btnSeleccionar = document.createElement("button");
    btnSeleccionar.innerHTML = '<span style="font-size:18px;display:inline-block;vertical-align:middle;">✔️</span>';
    btnSeleccionar.title = "Seleccionar";
    btnSeleccionar.style.background = '#e3f2fd';
    btnSeleccionar.style.color = '#1976d2';
    btnSeleccionar.style.border = 'none';
    btnSeleccionar.style.padding = '6px 10px';
    btnSeleccionar.style.fontSize = '26px';
    btnSeleccionar.style.borderRadius = '50%';
    btnSeleccionar.style.cursor = 'pointer';
    btnSeleccionar.style.transition = 'background 0.2s';
    btnSeleccionar.onmouseover = function() { btnSeleccionar.style.background = '#bbdefb'; };
    btnSeleccionar.onmouseout = function() { btnSeleccionar.style.background = '#e3f2fd'; };
    btnSeleccionar.onclick = function() {
      // Abrir modal para registrar cliente
      abrirModalCliente(fila);
    };
    celdaOpciones.appendChild(btnSeleccionar);

    // Botón Eliminar (icono papelera)
    const btnEliminar = document.createElement("button");
    btnEliminar.innerHTML = '<span style="font-size:18px;display:inline-block;vertical-align:middle;">🗑️</span>';
    btnEliminar.title = "Eliminar";
    btnEliminar.style.background = '#ffebee';
    btnEliminar.style.color = '#c62828';
    btnEliminar.style.border = 'none';
    btnEliminar.style.padding = '6px 10px';
    btnEliminar.style.fontSize = '26px';
    btnEliminar.style.borderRadius = '50%';
    btnEliminar.style.cursor = 'pointer';
    btnEliminar.style.transition = 'background 0.2s';
    btnEliminar.onmouseover = function() { btnEliminar.style.background = '#ffcdd2'; };
    btnEliminar.onmouseout = function() { btnEliminar.style.background = '#ffebee'; };
    btnEliminar.onclick = function() {
  const confirmar = confirm("¿Está seguro de que desea eliminar este artículo?");
  if (confirmar) {
    fila.remove();
    guardarTabla();
  }
};
    celdaOpciones.appendChild(btnEliminar);

    fila.appendChild(celdaOpciones);
    tablaBody.appendChild(fila);
    // Estilo para la fila seleccionada
    const styleSeleccionada = document.createElement('style');
    styleSeleccionada.innerHTML = `
      tr.seleccionada {
        background: #e3f2fd !important;
        box-shadow: 0 0 0 2px #1976d2 inset;
        transition: background 0.2s;
      }
    `;
    document.head.appendChild(styleSeleccionada);
  }

  // Modal cliente: lógica para abrir y llenar datos
  const modalCliente = document.getElementById('modalCliente');
  const formCliente = document.getElementById('formCliente');
  const cerrarModalCliente = document.getElementById('cerrarModalCliente');
  const inputCliente = document.getElementById('inputCliente');
  const inputModeloCliente = document.getElementById('inputModeloCliente');
  const inputInicialCliente = document.getElementById('inputInicialCliente');
  const inputWeppaCliente = document.getElementById('inputWeppaCliente');
  const inputCuotasCliente = document.getElementById('inputCuotasCliente');
  const inputFechaCliente = document.getElementById('inputFechaCliente');
  const inputPagoCliente = document.getElementById('inputPagoCliente');

  function abrirModalCliente(fila) {
    // Obtener datos de la fila
    const celdas = fila.querySelectorAll('td');
    // Modelo, Inicial, WEPPA, Cuotas
    inputModeloCliente.value = celdas[0].textContent.trim();
    // Guardar el valor sugerido de inicial para validación posterior
    const inicialSugerido = celdas[3].textContent.trim().replace('$','');
    inputInicialCliente.value = inicialSugerido;
    inputInicialCliente.setAttribute('data-inicial-sugerido', inicialSugerido);
    inputWeppaCliente.value = celdas[7].textContent.trim().replace('$','');
    inputCuotasCliente.value = celdas[4].textContent.trim().replace('$','');
    // Fecha actual (ajustada a zona horaria local)
    const hoy = new Date();
    const hoyLocal = new Date(hoy.getTime() - hoy.getTimezoneOffset() * 60000);
    inputFechaCliente.value = hoyLocal.toISOString().slice(0,10);
    inputCliente.value = '';

    // Calcular próximo martes
    let diaSemana = hoy.getDay(); // 0=domingo, 1=lunes, ..., 2=martes
    let diasParaMartes = (2 - diaSemana + 7) % 7;
    if (diasParaMartes === 0) diasParaMartes = 7; // Si hoy es martes, ir al próximo martes
    let proximoMartes = new Date(hoy);
    proximoMartes.setDate(hoy.getDate() + diasParaMartes - 0);
    const proximoMartesLocal = new Date(proximoMartes.getTime() - proximoMartes.getTimezoneOffset() * 60000);
    inputPagoCliente.value = proximoMartesLocal.toISOString().slice(0,10);

    modalCliente.style.display = 'flex';
  }
  cerrarModalCliente.onclick = function() {
    modalCliente.style.display = 'none';
    formCliente.reset();
  };

formCliente.onsubmit = function(e) {
  e.preventDefault();
  // Obtener valores de los inputs
  const cliente = inputCliente.value.trim();
  const modelo = inputModeloCliente.value.trim();
  const compra = inputFechaCliente.value.trim();
  const inicial = inputInicialCliente.value.trim();
  const inicialSugerido = inputInicialCliente.getAttribute('data-inicial-sugerido') || '';
  const weppa = inputWeppaCliente.value.trim();
  const cuotas = inputCuotasCliente.value.trim();
  const pago = inputPagoCliente.value.trim();
  // Obtener tasas de datos generales
  const bin = localStorage.getItem('dg_bin') || '';
  const bcv = localStorage.getItem('dg_bcv') || '';
  // Calcular balance igual que en agregarFila
  let balance = '';
  let weppaNum = parseFloat(weppa) || 0;
  balance = (weppaNum * -0.4 + weppaNum).toFixed(2);

  // Insertar fila en tablaClientes
  const tablaClientesBody = document.querySelector('#tablaClientes tbody');
  const fila = document.createElement('tr');
  // Orden: CLIENTE, MODELO, COMPRA(fecha), INICIAL, BALANCE, PAGO, CUOTA, WEPPA, BIN, BCV, OPCIONES
  const celdas = [
    cliente,
    modelo,
    compra,
    inicial,
    balance,
    pago,
    cuotas,
    weppa,
    bin,
    bcv
  ];
  celdas.forEach((valor, idx) => {
    const td = document.createElement('td');
    if (idx === 0) {
      td.innerHTML = `<strong>${valor}</strong>`;
    } else if (idx === 3) { // INICIAL
      td.textContent = valor;
      // Si el valor ingresado es menor al sugerido, marcar en rojo
      let inicialNum = parseFloat(valor.replace('$',''));
      let sugeridoNum = parseFloat(inicialSugerido);
      if (!isNaN(inicialNum) && !isNaN(sugeridoNum) && inicialNum < sugeridoNum) {
        td.style.background = '#ffcccc';
        td.style.color = '#b71c1c';
        td.title = 'El valor ingresado es menor al sugerido';
      }
    } else {
      td.textContent = valor;
    }
    fila.appendChild(td);
  });
  // Celda de opciones (eliminar)
  const tdOpciones = document.createElement('td');
  tdOpciones.className = 'eliminar-td';
  tdOpciones.style.display = 'flex';
  tdOpciones.style.justifyContent = 'center';
  tdOpciones.style.alignItems = 'center';
  tdOpciones.style.gap = '8px';
  // Botón eliminar
  const btnEliminar = document.createElement('button');
  btnEliminar.innerHTML = '<span style="font-size:18px;display:inline-block;vertical-align:middle;">🗑️</span>';
  btnEliminar.title = 'Eliminar';
  btnEliminar.style.background = '#ffebee';
  btnEliminar.style.color = '#c62828';
  btnEliminar.style.border = 'none';
  btnEliminar.style.padding = '6px 10px';
  btnEliminar.style.fontSize = '26px';
  btnEliminar.style.borderRadius = '50%';
  btnEliminar.style.cursor = 'pointer';
  btnEliminar.style.transition = 'background 0.2s';
  btnEliminar.onmouseover = function() { btnEliminar.style.background = '#ffcdd2'; };
  btnEliminar.onmouseout = function() { btnEliminar.style.background = '#ffebee'; };
  btnEliminar.onclick = function() {
    const confirmar = confirm("¿Está seguro de que desea eliminar este cliente?");
    if (confirmar) {
      fila.remove();
      guardarTablaClientes();
    }
  };
  tdOpciones.appendChild(btnEliminar);
  fila.appendChild(tdOpciones);
  tablaClientesBody.appendChild(fila);

  guardarTablaClientes();
  modalCliente.style.display = 'none';
  formCliente.reset();
};



  // --- CLIENTES: Guardar y cargar tabla en localStorage ---
  function obtenerDatosTablaClientes() {
    const tablaClientesBody = document.querySelector('#tablaClientes tbody');
    return Array.from(tablaClientesBody.querySelectorAll('tr')).map(tr =>
      Array.from(tr.querySelectorAll('td')).filter(td => !td.classList.contains('eliminar-td')).map(td => td.textContent)
    );
  }

  function guardarTablaClientes() {
    const filas = obtenerDatosTablaClientes();
    localStorage.setItem("tablaClientes", JSON.stringify(filas));
  }

  function cargarTablaClientes() {
    const datos = localStorage.getItem("tablaClientes");
    if (datos) {
      const filas = JSON.parse(datos);
      const tablaClientesBody = document.querySelector('#tablaClientes tbody');
      tablaClientesBody.innerHTML = "";
      filas.forEach(valores => {
        // Reutiliza la lógica de agregar fila de cliente
        agregarFilaCliente(valores);
      });
    }
  }

  // Lógica para agregar fila a la tabla de clientes (usada en cargarTablaClientes)
  function agregarFilaCliente(celdas) {
    const tablaClientesBody = document.querySelector('#tablaClientes tbody');
    const fila = document.createElement('tr');
    celdas.forEach((valor, idx) => {
      const td = document.createElement('td');
      if (idx === 0) {
        td.innerHTML = `<strong>${valor}</strong>`;
      } else if (idx === 3) { // INICIAL
        td.textContent = valor;
        // Si el valor ingresado es menor al sugerido, marcar en rojo
        // No se puede validar sugerido aquí, solo color si es negativo
        let inicialNum = parseFloat(valor.replace('$',''));
        if (!isNaN(inicialNum) && inicialNum < 0) {
          td.style.background = '#ffcccc';
          td.style.color = '#b71c1c';
        }
      } else {
        td.textContent = valor;
      }
      fila.appendChild(td);
    });
    // Celda de opciones (eliminar)
    const tdOpciones = document.createElement('td');
    tdOpciones.className = 'eliminar-td';
    tdOpciones.style.display = 'flex';
    tdOpciones.style.justifyContent = 'center';
    tdOpciones.style.alignItems = 'center';
    tdOpciones.style.gap = '8px';
    // Botón eliminar
    const btnEliminar = document.createElement('button');
    btnEliminar.innerHTML = '<span style="font-size:18px;display:inline-block;vertical-align:middle;">🗑️</span>';
    btnEliminar.title = 'Eliminar';
    btnEliminar.style.background = '#ffebee';
    btnEliminar.style.color = '#c62828';
    btnEliminar.style.border = 'none';
    btnEliminar.style.padding = '6px 10px';
    btnEliminar.style.fontSize = '26px';
    btnEliminar.style.borderRadius = '50%';
    btnEliminar.style.cursor = 'pointer';
    btnEliminar.style.transition = 'background 0.2s';
    btnEliminar.onmouseover = function() { btnEliminar.style.background = '#ffcdd2'; };
    btnEliminar.onmouseout = function() { btnEliminar.style.background = '#ffebee'; };
    btnEliminar.onclick = function() {
      const confirmar = confirm("¿Está seguro de que desea eliminar este cliente?");
      if (confirmar) {
        fila.remove();
        guardarTablaClientes();
      }
    };
    tdOpciones.appendChild(btnEliminar);
    fila.appendChild(tdOpciones);
    tablaClientesBody.appendChild(fila);
  }

  // Al cargar la página, restaurar la tabla de clientes
  cargarTablaClientes();


  function abrirFormulario() {
    camposContainer.innerHTML = "";
    // Solo mostrar MODELOS (0), PARALELOS (6) y WEPA (7)
    const indices = [0,6,7];
    indices.forEach(index => {
      let th = encabezados[index];
      let label = document.createElement("label");
      // Cambiar el label de TOPE a WEPA
      if (index === 7) {
        label.textContent = "WEPPA";
      } else {
        label.textContent = th.textContent;
      }
      const input = document.createElement("input");
      input.type = "text";
      input.name = `col${index}`;
      camposContainer.appendChild(label);
      camposContainer.appendChild(input);
    });
    modal.classList.add('mostrar');
    // Forzar reflow para animación
    void modal.offsetWidth;
    modal.querySelector('.modal-content').style.opacity = '1';
    modal.querySelector('.modal-content').style.transform = 'scale(1)';
  }

  function cerrarFormulario() {
    // Animar cierre
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.opacity = '0';
    modalContent.style.transform = 'scale(0.92)';
    setTimeout(() => {
      modal.classList.remove('mostrar');
      formulario.reset();
    }, 350);
  }

  formulario.onsubmit = function(e) {
    e.preventDefault();
    // Obtener datos generales
    const binTasa = parseFloat(localStorage.getItem('dg_bin')) || 0;
    const bcvTasa = parseFloat(localStorage.getItem('dg_bcv')) || 0;
    // Obtener valores del formulario
    const modelo = formulario[`col0`].value;
    const paralelos = formulario[`col6`].value;
    const weppa = formulario[`col7`].value;
    // Obtener valor BIN ingresado por el usuario
    let binInput = 0;
    if (formulario[`col6`]) {
      // Si el campo paralelos se usa para BIN, pero por claridad agregamos un input para BIN
      binInput = parseFloat(formulario[`col6`].value) || 0;
    }
    // Buscar si hay un campo BIN en el formulario (por si el usuario lo agrega manualmente)
    if (formulario[`col1`]) {
      binInput = parseFloat(formulario[`col1`].value) || binInput;
    }
    // Si no hay input, pedirlo
    if (!binInput) {
      binInput = 1;
    }
    // Calcular BCV (bs) y DÓLAR BCV
    const bcv = (binTasa * binInput).toFixed(2);
    let dolarBcv = "0";
    if (bcvTasa) {
      dolarBcv = Math.ceil(bcv / bcvTasa).toString();
    }
    // Calcular balance: weppa * -0.4 + weppa
    let balance = "";
    let weppaNum = parseFloat(weppa) || 0;
    balance = (weppaNum * -0.4 + weppaNum).toFixed(2);
    // Calcular inicial: redondeado a más (dolarBcv * 1.05) - balance
    let inicial = "";
    let dolarBcvNum = parseFloat(dolarBcv) || 0;
    let balanceNum = parseFloat(balance) || 0;
    inicial = Math.ceil((dolarBcvNum * 1.05) - balanceNum).toString();
    // Calcular cuotas: redondear a más balance * 1.35 / 6
    let cuotas = "";
    cuotas = Math.ceil((balanceNum * 1.35) / 6).toString();
    // Construir la fila con los valores en su posición
    const valores = [];
    for (let i = 0; i < 8; i++) {
      if (i === 0) valores.push(modelo);
      else if (i === 1) valores.push(bcv+"bs");
      else if (i === 2) valores.push(dolarBcv+"$");
      else if (i === 3) valores.push(inicial+"$");
      else if (i === 4) valores.push(cuotas+"$");
      else if (i === 5) valores.push(balance+"$");
      else if (i === 6) valores.push(paralelos+"$");
      else if (i === 7) valores.push(weppa+"$");
      else valores.push("");
    }
    agregarFila(valores);
    guardarTabla();
    cerrarFormulario();
  };


  btnAgregar.onclick = function(e) {
    e.preventDefault();
    abrirFormulario();
  };


  window.onclick = function(event) {
    if (event.target === modal) {
      cerrarFormulario();
    }
  };

  // Restaurar tabla al cargar
  cargarTabla();
</script>

</body>
</html>
